<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQLBot åµŒå…¥å¼é¡µé¢æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6f7;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #1f2329;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .config-panel {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .config-panel h2 {
      font-size: 16px;
      color: #1f2329;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .form-group {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .form-group label {
      min-width: 100px;
      color: #646a73;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      flex: 1;
      min-width: 200px;
      max-width: 400px;
      padding: 8px 12px;
      border: 1px solid #d9dcdf;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #1cba90;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #1cba90;
      color: #fff;
    }

    .btn-primary:hover {
      background: #17a57f;
    }

    .btn-secondary {
      background: #f5f6f7;
      color: #1f2329;
      border: 1px solid #d9dcdf;
    }

    .btn-secondary:hover {
      background: #eee;
    }

    .test-area {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 20px;
    }

    .test-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .test-card-header {
      padding: 12px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .test-card-header h3 {
      font-size: 14px;
      color: #1f2329;
      font-weight: 500;
    }

    .test-card-header .tag {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      background: #e8f7f3;
      color: #1cba90;
    }

    .iframe-container {
      width: 100%;
      height: 640px;
      position: relative;
      background: #f5f6f7;
    }

    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .iframe-container.assistant-mode {
      height: 700px;
    }

    .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #8f959e;
      font-size: 14px;
    }

    .log-panel {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .log-panel h2 {
      font-size: 14px;
      color: #1f2329;
      margin-bottom: 12px;
    }

    .log-content {
      background: #1f2329;
      color: #e8e8e8;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-content .log-item {
      margin-bottom: 4px;
    }

    .log-content .log-time {
      color: #8f959e;
    }

    .log-content .log-info {
      color: #67c23a;
    }

    .log-content .log-warn {
      color: #e6a23c;
    }

    .log-content .log-error {
      color: #f56c6c;
    }

    .tips {
      background: #fff8e6;
      border: 1px solid #ffeeba;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 20px;
      color: #856404;
      font-size: 13px;
    }

    .tips strong {
      display: block;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ§ª SQLBot åµŒå…¥å¼é¡µé¢æµ‹è¯•</h1>

    <div class="tips">
      <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
      <strong>å°åŠ©æ‰‹åµŒå…¥ï¼š</strong>è¾“å…¥å°åŠ©æ‰‹çš„æ•°æ®åº“ IDï¼ˆåœ¨ç³»ç»Ÿç®¡ç†â†’åµŒå…¥ç®¡ç†â†’å°åŠ©æ‰‹åµŒå…¥è¡¨æ ¼ä¸­æŸ¥çœ‹ï¼‰<br>
      <strong>é¡µé¢åµŒå…¥ï¼š</strong>è¾“å…¥é¡µé¢åµŒå…¥åº”ç”¨çš„<b>æ•°æ®åº“ ID</b>ï¼ˆå¯ä»¥åœ¨æ•°æ®åº“ sys_assistant è¡¨ä¸­æŸ¥è¯¢ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜è·å–ï¼‰<br>
      <strong>âš ï¸ æç¤ºï¼š</strong>æ•°æ®åº“ ID æ˜¯æ•°å­—ï¼ˆå¦‚ 1ã€2ã€3ï¼‰ï¼Œä¸æ˜¯ APP IDï¼ˆå¦‚ ZsmSvWeNAjQ=ï¼‰
    </div>

    <div class="config-panel">
      <h2>âš™ï¸ æµ‹è¯•é…ç½®</h2>
      <div class="form-group">
        <label>æœåŠ¡å™¨åœ°å€ï¼š</label>
        <input type="text" id="serverUrl" value="http://localhost:5173" placeholder="å¦‚ï¼šhttp://localhost:5173">
      </div>
      <div class="form-group">
        <label>åç«¯APIåœ°å€ï¼š</label>
        <input type="text" id="apiUrl" value="http://localhost:8000" placeholder="å¦‚ï¼šhttp://localhost:8000">
      </div>
      <div class="form-group">
        <label>åµŒå…¥ç±»å‹ï¼š</label>
        <select id="embedType" onchange="toggleEmbedFields()">
          <option value="assistant">å°åŠ©æ‰‹åµŒå…¥ (assistant)</option>
          <option value="page">é¡µé¢åµŒå…¥ (embeddedPage)</option>
        </select>
      </div>
      <div class="form-group" id="idGroup">
        <label id="idLabel">æ•°æ®åº“ IDï¼š</label>
        <input type="text" id="dbId" placeholder="æ•°æ®åº“ä¸­çš„æ•°å­— IDï¼ˆå¦‚ 1ã€2ã€3ï¼‰">
      </div>
      <div class="form-group">
        <label>åœ¨çº¿æ¨¡å¼ï¼š</label>
        <select id="onlineMode">
          <option value="true">åœ¨çº¿ (online=true)</option>
          <option value="false">ç¦»çº¿ (online=false)</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ˜¾ç¤ºå†å²ï¼š</label>
        <select id="showHistory">
          <option value="true">æ˜¾ç¤º (history=true)</option>
          <option value="false">éšè— (history=false)</option>
        </select>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="loadEmbed()">ğŸš€ åŠ è½½é¡µé¢</button>
        <button class="btn btn-secondary" onclick="clearEmbed()">ğŸ—‘ï¸ æ¸…é™¤</button>
        <button class="btn btn-secondary" onclick="clearLog()">ğŸ“‹ æ¸…é™¤æ—¥å¿—</button>
      </div>
    </div>

    <div class="test-area">
      <div class="test-card">
        <div class="test-card-header">
          <h3>ğŸ“± åµŒå…¥é¢„è§ˆ</h3>
          <span class="tag" id="embedTag">æœªåŠ è½½</span>
        </div>
        <div class="iframe-container" id="iframeContainer">
          <div class="placeholder">
            è¯·é…ç½®å‚æ•°åç‚¹å‡»"åŠ è½½é¡µé¢"
          </div>
        </div>
      </div>
    </div>

    <div class="log-panel">
      <h2>ğŸ“ é€šä¿¡æ—¥å¿—</h2>
      <div class="log-content" id="logContent">
        <div class="log-item">
          <span class="log-time">[--:--:--]</span>
          <span class="log-info">ç­‰å¾…åŠ è½½åµŒå…¥é¡µé¢...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // åˆ‡æ¢åµŒå…¥ç±»å‹æ—¶æ›´æ–°æ ‡ç­¾
    function toggleEmbedFields() {
      const embedType = document.getElementById('embedType').value;
      const idLabel = document.getElementById('idLabel');
      if (embedType === 'assistant') {
        idLabel.textContent = 'å°åŠ©æ‰‹æ•°æ®åº“ IDï¼š';
      } else {
        idLabel.textContent = 'é¡µé¢åµŒå…¥æ•°æ®åº“ IDï¼š';
      }
    }

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logContent = document.getElementById('logContent');
      const time = new Date().toLocaleTimeString();
      const logItem = document.createElement('div');
      logItem.className = 'log-item';
      logItem.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      logContent.appendChild(logItem);
      logContent.scrollTop = logContent.scrollHeight;
    }

    // æ¸…é™¤æ—¥å¿—
    function clearLog() {
      const logContent = document.getElementById('logContent');
      logContent.innerHTML = '<div class="log-item"><span class="log-time">[' + new Date().toLocaleTimeString() + ']</span> <span class="log-info">æ—¥å¿—å·²æ¸…é™¤</span></div>';
    }

    // è·å– token
    async function getToken(apiUrl, id) {
      try {
        const url = `${apiUrl}/api/v1/system/assistant/validator?id=${id}&virtual=${Date.now()}`;
        log(`æ­£åœ¨è·å– token...`, 'info');
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        log(`è·å– token æˆåŠŸ`, 'info');
        return data.token || null;
      } catch (error) {
        log(`è·å– token å¤±è´¥: ${error.message}`, 'error');
        return null;
      }
    }

    // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
    window.addEventListener('message', async function (event) {
      const data = event.data;
      if (data && data.eventName) {
        if (data.eventName === 'sqlbot_embedded_event' || data.eventName === 'sqlbot_assistant_event') {
          log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');

          // å¦‚æœæ˜¯ ready æ¶ˆæ¯ï¼Œå‘é€ certificate
          if (data.busi === 'ready' && data.ready) {
            log('åµŒå…¥é¡µé¢å·²å‡†å¤‡å°±ç»ªï¼Œå‡†å¤‡å‘é€è®¤è¯ä¿¡æ¯...', 'info');
            const iframe = document.querySelector('#iframeContainer iframe');
            if (iframe) {
              const embedType = document.getElementById('embedType').value;
              const apiUrl = document.getElementById('apiUrl').value.trim().replace(/\/$/, '');

              let certificate = null;
              let type = 1;

              if (embedType === 'page') {
                // é¡µé¢åµŒå…¥ï¼šä½¿ç”¨ type=2ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
                type = 2;
                // ä» data-db-id å±æ€§è·å–æ•°æ®åº“ ID
                const dbId = iframe.getAttribute('data-db-id');
                if (dbId) {
                  certificate = await getToken(apiUrl, dbId);
                }
                if (!certificate) {
                  log('âš ï¸ è­¦å‘Šï¼šæœªèƒ½è·å– tokenï¼Œé¡µé¢å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ', 'warn');
                }
              }
              // å°åŠ©æ‰‹åµŒå…¥ (type=1) ä¸éœ€è¦ certificateï¼Œiframe å†…éƒ¨ä¼šè‡ªå·±è·å– token

              const responseData = {
                eventName: data.eventName,
                busi: 'certificate',
                certificate: certificate,
                messageId: data.messageId,
                type: type
              };
              iframe.contentWindow.postMessage(responseData, '*');
              log(`è®¤è¯ä¿¡æ¯å·²å‘é€: type=${type}, certificate=${certificate ? 'å·²è·å–' : 'ç©º'}`, 'info');
            }
          }
        }
      }
    });

    // åŠ è½½åµŒå…¥é¡µé¢
    async function loadEmbed() {
      const serverUrl = document.getElementById('serverUrl').value.trim().replace(/\/$/, '');
      const apiUrl = document.getElementById('apiUrl').value.trim().replace(/\/$/, '');
      const embedType = document.getElementById('embedType').value;
      const onlineMode = document.getElementById('onlineMode').value;
      const showHistory = document.getElementById('showHistory').value;
      const dbId = document.getElementById('dbId').value.trim();

      if (!serverUrl) {
        log('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼', 'error');
        alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼');
        return;
      }

      if (!apiUrl) {
        log('è¯·è¾“å…¥åç«¯APIåœ°å€ï¼', 'error');
        alert('è¯·è¾“å…¥åç«¯APIåœ°å€ï¼');
        return;
      }

      if (!dbId) {
        log('è¯·è¾“å…¥æ•°æ®åº“ IDï¼', 'error');
        alert('è¯·è¾“å…¥æ•°æ®åº“ IDï¼');
        return;
      }

      // éªŒè¯ ID æ˜¯æ•°å­—
      if (!/^\d+$/.test(dbId)) {
        log('âŒ æ•°æ®åº“ ID å¿…é¡»æ˜¯æ•°å­—ï¼', 'error');
        alert('æ•°æ®åº“ ID å¿…é¡»æ˜¯æ•°å­—ï¼è¯·è¾“å…¥æ•°å­— IDï¼ˆå¦‚ 1ã€2ã€3ï¼‰ï¼Œè€Œé APP ID');
        return;
      }

      const container = document.getElementById('iframeContainer');
      const tag = document.getElementById('embedTag');

      let embedUrl;

      if (embedType === 'page') {
        // é¡µé¢åµŒå…¥
        embedUrl = `${serverUrl}/#/embeddedPage?id=${dbId}&type=2&online=${onlineMode}&history=${showHistory}`;
        tag.textContent = 'é¡µé¢åµŒå…¥(æµ‹è¯•)';
        container.classList.remove('assistant-mode');
      } else {
        // å°åŠ©æ‰‹åµŒå…¥
        embedUrl = `${serverUrl}/#/assistant?id=${dbId}&online=${onlineMode}&history=${showHistory}`;
        tag.textContent = 'å°åŠ©æ‰‹åµŒå…¥';
        container.classList.add('assistant-mode');
      }

      log(`æ­£åœ¨åŠ è½½: ${embedUrl}`, 'info');

      // åˆ›å»º iframeï¼Œå¹¶ä¿å­˜æ•°æ®åº“ ID ä»¥ä¾¿åç»­ä½¿ç”¨
      container.innerHTML = `<iframe 
        src="${embedUrl}" 
        data-db-id="${dbId}"
        allow="microphone; clipboard-read; clipboard-write"
      ></iframe>`;

      log('iframe å·²åˆ›å»ºï¼Œç­‰å¾…é¡µé¢åŠ è½½...', 'info');
    }

    // æ¸…é™¤åµŒå…¥
    function clearEmbed() {
      const container = document.getElementById('iframeContainer');
      const tag = document.getElementById('embedTag');

      container.innerHTML = '<div class="placeholder">è¯·é…ç½®å‚æ•°åç‚¹å‡»"åŠ è½½é¡µé¢"</div>';
      container.classList.remove('assistant-mode');
      tag.textContent = 'æœªåŠ è½½';

      log('åµŒå…¥é¡µé¢å·²æ¸…é™¤', 'warn');
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œè¯·å¡«å†™å‚æ•°åç‚¹å‡»åŠ è½½', 'info');
  </script>
</body>

</html>